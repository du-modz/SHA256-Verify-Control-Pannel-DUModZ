<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DUModZ Admin Panel</title>
    
    <!-- Tailwind CSS & Google Fonts -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, update } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";
        import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        // --- তোমার দেওয়া সঠিক কনফিগারেশন ---
        const firebaseConfig = {
            apiKey: "AIzaSyC_DtbizYw47RMwx6QG-CSTPdpEgmIQ7wM",
            authDomain: "sha257-varify-dumodz.firebaseapp.com",
            databaseURL: "https://sha257-varify-dumodz-default-rtdb.firebaseio.com",
            projectId: "sha257-varify-dumodz",
            storageBucket: "sha257-varify-dumodz.firebasestorage.app",
            messagingSenderId: "411803659932",
            appId: "1:411803659932:web:fece07d6b9cd346f330759",
            measurementId: "G-YQSN090BBT"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const auth = getAuth(app);

        // ডাটাবেস পাথ (তুমি যে পাথটি দিয়েছ)
        const DB_PATH = "verify-sha256-data-dumodz"; 

        let currentData = null;

        // UI Selectors
        const loginPage = document.getElementById('login-page');
        const dashboard = document.getElementById('dashboard');
        const appCardsContainer = document.getElementById('app-cards-container');

        // 1. Auth Logic
        window.login = async () => {
            const email = document.getElementById('email').value;
            const pass = document.getElementById('password').value;
            if(!email || !pass) return Swal.fire('Error', 'Please fill all fields', 'error');
            
            try {
                await signInWithEmailAndPassword(auth, email, pass);
                Swal.fire('Success', 'Admin Access Granted', 'success');
            } catch (error) {
                Swal.fire('Login Failed', error.message, 'error');
            }
        };

        window.logout = () => {
            signOut(auth).then(() => location.reload());
        };

        onAuthStateChanged(auth, (user) => {
            if (user) {
                loginPage.classList.add('hidden');
                dashboard.classList.remove('hidden');
                loadData();
            } else {
                loginPage.classList.remove('hidden');
                dashboard.classList.add('hidden');
            }
        });

        // 2. Load Data (Fix: সঠিক পাথে ডাটা খোঁজা হচ্ছে)
        function loadData() {
            const dbRef = ref(db, DB_PATH);
            onValue(dbRef, (snapshot) => {
                const data = snapshot.val();
                if (data) {
                    currentData = data;
                    renderDashboard(data);
                } else {
                    console.log("No data found at path: " + DB_PATH);
                }
            });
        }

        function renderDashboard(data) {
            document.getElementById('admin-label-text').innerText = data.admin_label || "No Label";
            document.getElementById('global-blocklist').value = data.global_blocklist || "";
            document.getElementById('contact-url').value = data.contact_url || "";
            document.getElementById('admin-title-input').value = data.admin_label || "";

            appCardsContainer.innerHTML = '';
            if(data.authorized_apps) {
                data.authorized_apps.forEach((app, index) => {
                    const card = `
                        <div class="card-neu p-5 rounded-3xl mb-6 animate-slide-in">
                            <div class="flex justify-between items-start mb-4">
                                <div class="w-10 h-10 rounded-2xl bg-gradient-to-br from-blue-500 to-purple-600 flex items-center justify-center text-white shadow-lg">
                                    <i class="fas fa-shield-halved"></i>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editApp(${index})" class="text-blue-500 p-2 px-3 rounded-xl bg-slate-100 btn-neu"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteApp(${index})" class="text-red-500 p-2 px-3 rounded-xl bg-slate-100 btn-neu"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                            <h3 class="font-bold text-lg mb-1">${app.note}</h3>
                            <p class="text-[11px] opacity-60 mb-3 font-mono">${app.package_name}</p>
                            <div class="bg-gray-100 dark:bg-slate-800 p-3 rounded-2xl text-[10px] font-mono break-all border border-white/20 mb-3 shadow-inner">
                                <span class="text-blue-500 font-bold">SHA256:</span> ${app.sha256_key}
                            </div>
                            <div class="text-[10px] text-red-500 font-semibold bg-red-50 p-2 rounded-lg">
                                <i class="fas fa-ban mr-1"></i> Blocklist: ${app.package_blocklist || 'None'}
                            </div>
                        </div>
                    `;
                    appCardsContainer.innerHTML += card;
                });
            }
        }

        // 3. Actions
        window.updateGlobalSettings = () => {
            const label = document.getElementById('admin-title-input').value;
            const url = document.getElementById('contact-url').value;
            const block = document.getElementById('global-blocklist').value;
            
            update(ref(db, DB_PATH), {
                admin_label: label,
                contact_url: url,
                global_blocklist: block
            }).then(() => Swal.fire('Updated!', 'Database Synced Successfully', 'success'));
        };

        window.addNewApp = async () => {
            const { value: f } = await Swal.fire({
                title: 'Add New Application',
                html: `
                    <input id="n-note" class="swal2-input" placeholder="User Name/Note">
                    <input id="n-pkg" class="swal2-input" placeholder="Package Name">
                    <input id="n-sha" class="swal2-input" placeholder="SHA256 Key">
                    <input id="n-block" class="swal2-input" placeholder="Blocklist Packages">`,
                preConfirm: () => ({
                    note: document.getElementById('n-note').value,
                    package_name: document.getElementById('n-pkg').value,
                    sha256_key: document.getElementById('n-sha').value,
                    package_blocklist: document.getElementById('n-block').value
                })
            });
            if (f) {
                const apps = currentData.authorized_apps || [];
                apps.push(f);
                update(ref(db, DB_PATH), { authorized_apps: apps });
            }
        };

        window.editApp = async (index) => {
            const a = currentData.authorized_apps[index];
            const { value: f } = await Swal.fire({
                title: 'Edit App Info',
                html: `
                    <input id="e-note" class="swal2-input" value="${a.note}" placeholder="Note">
                    <input id="e-pkg" class="swal2-input" value="${a.package_name}" placeholder="Package">
                    <input id="e-sha" class="swal2-input" value="${a.sha256_key}" placeholder="SHA256">
                    <input id="e-block" class="swal2-input" value="${a.package_blocklist}" placeholder="Blocklist">`,
                preConfirm: () => ({
                    note: document.getElementById('e-note').value,
                    package_name: document.getElementById('e-pkg').value,
                    sha256_key: document.getElementById('e-sha').value,
                    package_blocklist: document.getElementById('e-block').value
                })
            });
            if (f) {
                const apps = [...currentData.authorized_apps];
                apps[index] = f;
                update(ref(db, DB_PATH), { authorized_apps: apps });
            }
        };

        window.deleteApp = (index) => {
            Swal.fire({
                title: 'Delete App?',
                text: "This will remove authorization for this app!",
                icon: 'warning',
                showCancelButton: true,
                confirmButtonColor: '#ef4444',
                confirmButtonText: 'Yes, Delete'
            }).then((res) => {
                if (res.isConfirmed) {
                    const apps = currentData.authorized_apps.filter((_, i) => i !== index);
                    update(ref(db, DB_PATH), { authorized_apps: apps });
                }
            });
        };

        window.toggleTheme = () => document.body.classList.toggle('dark-mode');

    </script>

    <style>
        :root { --bg: #e6eef8; --s-light: #ffffff; --s-dark: #bec8d4; --text: #2d3748; }
        .dark-mode { --bg: #1a202c; --s-light: #2d3748; --s-dark: #0a0e14; --text: #f7fafc; }

        body { font-family: 'Poppins', sans-serif; background: var(--bg); color: var(--text); transition: 0.4s; }
        .card-neu { background: var(--bg); box-shadow: 10px 10px 20px var(--s-dark), -10px -10px 20px var(--s-light); }
        .input-neu { background: var(--bg); box-shadow: inset 6px 6px 12px var(--s-dark), inset -6px -6px 12px var(--s-light); border: none; outline: none; }
        .btn-neu { background: var(--bg); box-shadow: 5px 5px 10px var(--s-dark), -5px -5px 10px var(--s-light); border: none; }
        .btn-neu:active { box-shadow: inset 3px 3px 6px var(--s-dark), inset -3px -3px 6px var(--s-light); transform: scale(0.98); }
        
        @keyframes slideIn { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .animate-slide-in { animation: slideIn 0.6s cubic-bezier(0.23, 1, 0.32, 1) forwards; }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 10px; }
    </style>
</head>
<body class="min-h-screen">

    <!-- LOGIN PAGE -->
    <div id="login-page" class="flex items-center justify-center min-h-screen p-6">
        <div class="card-neu p-10 rounded-[45px] w-full max-w-sm text-center">
            <div class="w-24 h-24 bg-gradient-to-tr from-blue-600 to-indigo-500 rounded-[30px] mx-auto mb-8 flex items-center justify-center text-white text-4xl shadow-2xl rotate-3">
                <i class="fas fa-lock"></i>
            </div>
            <h2 class="text-3xl font-extrabold mb-8 tracking-tight">Admin Portal</h2>
            <input type="email" id="email" placeholder="Email Address" class="input-neu w-full p-5 rounded-2xl mb-5">
            <input type="password" id="password" placeholder="Password" class="input-neu w-full p-5 rounded-2xl mb-8">
            <button onclick="login()" class="btn-neu w-full py-5 rounded-2xl font-bold text-blue-600 text-lg">Sign In</button>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden pb-32">
        <header class="p-6 flex justify-between items-center sticky top-0 z-50 bg-opacity-70 backdrop-blur-xl">
            <div>
                <p class="text-[10px] font-bold opacity-50 uppercase tracking-widest">Welcome back,</p>
                <h1 id="admin-label-text" class="text-2xl font-black">DUModZ Admin</h1>
            </div>
            <div class="flex gap-4">
                <button onclick="toggleTheme()" class="btn-neu w-12 h-12 rounded-full flex items-center justify-center text-lg"><i class="fas fa-moon"></i></button>
                <button onclick="logout()" class="btn-neu w-12 h-12 rounded-full flex items-center justify-center text-red-500 text-lg"><i class="fas fa-power-off"></i></button>
            </div>
        </header>

        <main class="container mx-auto px-5 max-w-[768px]">
            <!-- Global Config -->
            <div class="card-neu p-8 rounded-[40px] mb-10 border border-white/30">
                <h2 class="font-bold text-xl mb-6 flex items-center gap-3"><i class="fas fa-gears text-blue-500"></i> Global Settings</h2>
                <div class="grid gap-6">
                    <div>
                        <label class="text-[10px] ml-3 mb-2 block font-black opacity-40 uppercase">Admin Label</label>
                        <input type="text" id="admin-title-input" class="input-neu w-full p-4 rounded-2xl">
                    </div>
                    <div>
                        <label class="text-[10px] ml-3 mb-2 block font-black opacity-40 uppercase">Contact Support URL</label>
                        <input type="text" id="contact-url" class="input-neu w-full p-4 rounded-2xl">
                    </div>
                    <div>
                        <label class="text-[10px] ml-3 mb-2 block font-black opacity-40 uppercase">Global Package Blocklist</label>
                        <textarea id="global-blocklist" class="input-neu w-full p-4 rounded-2xl h-24 resize-none"></textarea>
                    </div>
                    <button onclick="updateGlobalSettings()" class="btn-neu w-full py-4 rounded-2xl font-bold text-green-600 shadow-lg">Save Changes</button>
                </div>
            </div>

            <!-- Apps Header -->
            <div class="flex justify-between items-center mb-8">
                <h2 class="text-2xl font-black">Authorized Apps</h2>
                <button onclick="addNewApp()" class="btn-neu px-6 py-3 rounded-2xl text-blue-600 font-black text-sm">
                    <i class="fas fa-plus-circle mr-2"></i> NEW APP
                </button>
            </div>

            <div id="app-cards-container" class="grid gap-6">
                <!-- Data will appear here -->
            </div>
        </main>

        <!-- Bottom Navigation Mobile -->
        <div class="fixed bottom-8 left-1/2 -translate-x-1/2 w-[90%] max-w-[450px] z-50">
            <div class="card-neu rounded-[35px] p-3 flex justify-around items-center backdrop-blur-md bg-opacity-80">
                <button class="w-14 h-14 rounded-2xl text-blue-600 flex items-center justify-center text-xl btn-neu"><i class="fas fa-grid-2"></i></button>
                <button onclick="addNewApp()" class="w-16 h-16 bg-gradient-to-tr from-blue-600 to-indigo-600 text-white rounded-2xl shadow-xl flex items-center justify-center text-2xl -translate-y-6 border-4 border-[#e6eef8] dark:border-[#1a202c]"><i class="fas fa-plus"></i></button>
                <button onclick="updateGlobalSettings()" class="w-14 h-14 rounded-2xl text-gray-500 flex items-center justify-center text-xl btn-neu"><i class="fas fa-save"></i></button>
            </div>
        </div>
    </div>

</body>
</html>
